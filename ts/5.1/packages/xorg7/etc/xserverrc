#! /bin/sh

. $TS_GLOBAL
. /etc/splash.functions

DISPLAY_NUMBER=0
XAUTHHOME=$HOME
LOGFILE=/var/run/applications/xorg

build_command ()
{
	# Base Xorg Configuration
	X_CMD="$X_SERVER :$DISPLAY_NUMBER -br -noreset -nolisten tcp vt05"

	# Define Font Paths
	if [ -n "$SCREEN_X_FONT_SERVER" ]; then
		X_CMD="$X_CMD -fp tcp/$SCREEN_X_FONT_SERVER"
	fi

	# Force DPI
	if [ -n "$X_DPI" ]; then
		X_CMD="$X_CMD -dpi $X_DPI"
	fi

	# Hide the mouse cursor
	if is_enabled $X_NO_CURSOR; then
		X_CMD="$X_CMD -nocursor"
	fi

	# Force a color depth
	if [ -n "$SCREEN_COLOR_DEPTH" ]; then
		X_CMD="$X_CMD -depth $SCREEN_COLOR_DEPTH"
	fi

}

if [ ! -e /tmp/.xorg-unix/X$DISPLAY_NUMBER ]; then
	echo "Starting $0 server" >> $LOGFILE
	if [ -n "$X_COOKIE" ] ; then
		xauth -f $XAUTHHOME/.Xauthority add :$DISPLAY_NUMBER.0 - $X_COOKIE >> $LOGFILE 2>&1
	fi
	if [ -n "$X_SERVER" ]; then
		build_command
		echo $X_CMD >> $LOGFILE
		$X_CMD >> $LOGFILE 2>&1 &
		splash_exit
	else
		echo "XSERVER variable is not defined, error!!!"
		echo "X aborted, starting shell instead."
		/bin/bash
	fi
fi

exit 0
